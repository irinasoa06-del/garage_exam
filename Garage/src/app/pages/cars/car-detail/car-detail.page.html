<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/cars"></ion-back-button>
    </ion-buttons>
    <ion-title>Détails</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="supprimerVoiture()">
        <ion-icon slot="icon-only" name="trash" color="danger"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div *ngIf="voiture">
    <!-- Carte d'info voiture -->
    <ion-card>
      <ion-card-header>
        <div class="car-header">
          <ion-icon name="car-sport" size="large" color="primary"></ion-icon>
          <div>
            <ion-card-title>{{ voiture.marque }} {{ voiture.modele }}</ion-card-title>
            <ion-card-subtitle>{{ voiture.immatriculation }}</ion-card-subtitle>
          </div>
          <ion-badge [color]="getStatutColor(voiture.statut)">
            {{ getStatutLabel(voiture.statut) }}
          </ion-badge>
        </div>
      </ion-card-header>
      <ion-card-content>
        <div class="car-info">
          <div class="info-item" *ngIf="voiture.annee">
            <span class="label">Année:</span>
            <span class="value">{{ voiture.annee }}</span>
          </div>
          <div class="info-item" *ngIf="voiture.couleur">
            <span class="label">Couleur:</span>
            <span class="value">{{ voiture.couleur }}</span>
          </div>
          <div class="info-item">
            <span class="label">Ajoutée le:</span>
            <span class="value">{{ voiture.date_ajout | date:'dd/MM/yyyy' }}</span>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Liste des réparations -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Réparations</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list *ngIf="reparations.length > 0">
          <ion-item *ngFor="let reparation of reparations">
            <ion-label>
              <h3>{{ reparation.type_intervention?.nom }}</h3>
              <p *ngIf="reparation.type_intervention?.duree_secondes">
                Durée: {{ formatDuree(reparation.type_intervention.duree_secondes) }}
              </p>
              <p class="price">{{ reparation.type_intervention?.prix_unitaire }} Ar</p>
            </ion-label>
            <div slot="end" class="reparation-status">
              <ion-badge [color]="getStatutColor(reparation.statut)">
                {{ getStatutLabel(reparation.statut) }}
              </ion-badge>
              <ion-progress-bar 
                *ngIf="reparation.statut === 'en_cours'"
                [value]="reparation.progression / 100"
                color="primary">
              </ion-progress-bar>
              <p *ngIf="reparation.statut === 'en_cours'" class="progression-text">
                {{ reparation.progression }}%
              </p>
            </div>
          </ion-item>
        </ion-list>

        <div class="empty-state" *ngIf="reparations.length === 0">
          <p>Aucune réparation en cours</p>
        </div>

        <!-- Total -->
        <div class="total-section" *ngIf="reparations.length > 0">
          <div class="total-line">
            <span>Total:</span>
            <span class="total-amount">{{ montantTotal }} Ar</span>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Bouton payer (si voiture prête) -->
    <div class="action-buttons" *ngIf="voiture.statut === 'prete'">
      <ion-button expand="block" color="success" (click)="payerReparations()">
        <ion-icon slot="start" name="card"></ion-icon>
        Payer et récupérer
      </ion-button>
    </div>

    <!-- Message selon le statut -->
    <ion-card *ngIf="voiture.statut === 'en_attente'" color="warning">
      <ion-card-content>
        <div class="status-message">
          <ion-icon name="time"></ion-icon>
          <p>Votre voiture est en attente de prise en charge</p>
        </div>
      </ion-card-content>
    </ion-card>

    <ion-card *ngIf="voiture.statut === 'en_reparation'" color="primary">
      <ion-card-content>
        <div class="status-message">
          <ion-icon name="construct"></ion-icon>
          <p>Vos réparations sont en cours. Vous recevrez une notification quand elles seront terminées.</p>
        </div>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>